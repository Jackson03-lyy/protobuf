syntax = "proto3";

package ros_sim;

import "google/protobuf/timestamp.proto";

// --- 基础几何结构 ---
message Vector3 {
    double x = 1;
    double y = 2;
    double z = 3;
}
message Quaternion {
    double x = 1;
    double y = 2;
    double z = 3;
    double w = 4;
}
message Pose {
    Vector3 position = 1;
    Quaternion orientation = 2;
}
// --- 关节控制模式枚举 ---
enum ControlMode {
    MODE_IDLE = 0;       // 怠速/放松模式（无力矩）
    MODE_POSITION = 1;   // 位置控制(给定角度, 弧度 (rad)）
    MODE_VELOCITY = 2;   // 速度控制（给定角速度,弧度/秒 (rad/s)）
    MODE_EFFORT = 3;     // 力矩控制（直接控制电机电流/力矩,牛・米 (N・m)）
}

// --- 关节属性定义 ---
message JointState {
    string name = 1;       // 关节名称 (如 "joint_1")
    double position = 2;         // 当前角度 (Unit: rad)
    double velocity = 3;         // 当前速度 (Unit: rad/s)
    double effort = 4;           // 当前力矩 (Unit: N・m)
    double temperature = 5;      // 仿真电机温度（可选，用于过热仿真）
}

message SingleJointCommand {
    int32 joint_id = 1;
    double target = 2;
    // 可选性：为每个关节单独设置 PID，只有在调试或需要改变刚度时才发送，节省带宽.
    optional double kp = 3;
    optional double kd = 4;
}
// --- 控制指令集 ---
message JointCommand {
    ControlMode mode = 1;
    repeated SingleJointCommand commands = 2; 
    // 结构化指令，防止顺序错误
    google.protobuf.Timestamp header_time = 3; // 发送指令的时间戳
    // 动态限制：在仿真运行时实时调整物理约束
    optional double velocity_limit = 4; // 限制最大速度
    optional double acceleration_limit = 5; // 限制最大加速度
}

// --- 仿真环境特有反馈 ---
message SimulationFeedback {
    google.protobuf.Timestamp stamp = 1; // 仿真同步时间戳
    repeated JointState joint_states = 2; // 所有关节的实时数据包
    
    bool is_in_collision = 3;            // 机械臂是否发生碰撞
    string collision_part = 4;           // 发生碰撞的连杆名称
}

// --- 心跳机制 ---
message Heartbeat {
    enum Status {
        STATUS_UNKNOWN = 0;
        STATUS_OK = 1;
        STATUS_WARNING = 2;
        STATUS_ERROR = 3;
    }
    
    google.protobuf.Timestamp timestamp = 1;          // 发送时间
    Status status = 2;                                // 系统状态
    uint32 frame_counter = 3;                         // 帧计数器，用于丢包检测
    double simulation_time = 4;                       // 当前仿真时间（秒）
    optional string status_message = 5;               // 可选状态信息
    repeated string warnings = 6;                     // 警告列表
}

// --- 顶层通信包装 (The Root Message) ---
message ArmPacket {
    // 头部信息
    uint64 sequence_number = 1;          // 包序号，用于处理 UDP 乱序和丢包
    string arm_id = 2;                   // 机械臂唯一标识（多机协同用）

    oneof payload {
        // 下行：主控 -> 仿真平台
        JointCommand joint_cmd = 3;      
        // 上行：仿真平台 -> 主控
        SimulationFeedback sim_status = 4;
        // 系统管理
        SystemAction sys_action = 5;
        // 心跳（双向）
        Heartbeat heartbeat = 6;
    }
}

message SystemAction {
    enum Type {
       START_SIMULATION = 0;   // 开始/启动仿真物理引擎
       STOP_SIMULATION  = 1;   // 停止仿真（通常会冻结所有物理属性）
       PAUSE_SIMULATION = 2;   // 暂停（画面冻结，状态保留）
       RESUME_SIMULATION = 3;  // 恢复播放

       // 状态重置
       RESET_JOINTS_TO_ZERO = 4; // 仅重置关节角度
       RELOAD_SCENE = 5;         // 重新加载整个场景（含障碍物）

        // 调试辅助
       ENABLE_GRAVITY = 6;     // 开启重力
       DISABLE_GRAVITY = 7;   // 关闭重力
    }
    Type type = 1;
    // 可选参数：比如跳转到特定的仿真时刻
    optional double seek_time = 2;
}